<!DOCTYPE html>
<html lang="en">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Live View</title>
	<head>
		<link href="css/bootstrap.min.css" type="text/css" rel="stylesheet"></link>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/autobahn.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script>
			window.wssession = null;
			var blinkerInterval = null,
				windowFocus = true,
				infiniteScroll = false,
				scrollTimeout = null;

			$(document).ready(function() {
				$(window).focus(function() {
					clearInterval(blinkerInterval);
					windowFocus = true;
					blinkerInterval = null;
					$("title").text("Live View");
				});

				$(window).blur(function() {
					windowFocus = false;
				});

				$(document).scroll(function() {
					clearTimeout(scrollTimeout);
					scrollTimeout = setTimeout(function() {

						var currentPos = $(window).scrollTop() + $(window).height();

						if (currentPos >= $(document).height()) {
							//This jquery gives us the the date/time of the last element on the page ;)
							//Will need to be updated though according to the structure of the tweets so this isn't a
							//best-practice since it's coupled tightly
							var date = new Date(Date.parse($("#stream ol li:last-child h4 small").html()));
							infiniteScroll = true;
							getSomeTweets(date.toISOString(), false);
							
						}
					}, 100);
				});

				var wsUrl = "ws://localhost:9001";
				if (window.location.origin !== "file://") {
					wsUrl = "ws://sugar.appendixg.com:9001";
				}

				ab.connect(wsUrl, function(session) {
					window.wssession = session;
					window.wssession.subscribe('feed', topicActivity);

					getSomeTweets(new Date().toISOString(), false);
				}, function(code, reason,detail) {
					console.log("WS connection attempt failed");
					console.log(reason);
				}, {
					'maxRetries': 60,
					'retryDelay': 2000
				});
			});
	
			function getSomeTweets(date) {
				if (typeof date === "undefined" || date === null) {
					date = new Date().toISOString();
				}

				window.wssession.call(window.wssession._wsuri + '#getInit', date).then(
					function(result) {
						if ("push" in result) {
							for (var i=0; i<result.length;i++) {
								tweet = JSON.parse(result[i].replace(/'/g, '"'));
								tweet['text'] = tweet['message'];
								addTweet(tweet, false);
							}
						} else {
							console.log("Uhh it's not an array....");
							console.log(result);
						}
						
					},
					function(error) {console.log(error);}
				);
			}
			function topicActivity(topic, event) {
				event = JSON.parse(event);
				console.log(event);
				if (event.hasOwnProperty("username")) {
					addTweet(event, true);
					blinkerInterval = window.setInterval(changeTitle, 700);
				}
			}

			function addTweet(tweet, prepend) {
				var children = $("#stream ol").children().length;
				
				if (children >= 10 && infiniteScroll === false) {
					console.log("Removin some shit");
					$("#stream ol li:last-child").remove();
				}

				var html = '' +
				'<li id="' + tweet['twitter_id'] + '">' +
				'	<div id="' + tweet['twitter_id'] + '_div" style="border-bottom: 1px solid #ccc; display: none;">' +
				'		<h4>' + tweet['username'] + '</h4>'+ 
				'		<p>' + tweet['text'] + '</p>' + 
				'		<a href="http://twitter.com/' + tweet['username'] + '/status/' + tweet['twitter_id'] + '" target="_blank"> Link to Tweet</a><div style="display: inline; margin-left: 18px;"><h4 style="display: inline;"><small>' + new Date(Date.parse(tweet['created_date'] + " GMT")).toLocaleString() + '</small></h4></div>' +
				'	</div>' +
				'</li>';

				if (infiniteScroll === true && prepend === false) {
					$("#stream ol").append(html);
				} else {
					$("#stream ol").prepend(html);
				}
				
				$("#" + tweet['twitter_id'] + "_div").fadeIn();
			}

			function changeTitle() {
				if (blinkerInterval !== null && windowFocus === false) {
					document.title = document.title == "Live View" ? "Activity!" : "Live View";
				} else {
					document.title = "Live View";
				} 
			}
		</script>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-md-8 col-md-offset-2">
					<div style="border-bottom:1px solid #ccc;">
						<h2>Stream</h2>
					</div>
					<div id="stream">
						<ol class="list-unstyled">
						</ol>
<!-- 						<div id="output">
							<p></p>
							<a href="" target="_blank">Linky</a>
						</div> -->
					</div>
				</div>
			</div>
		</div>
	</body>
</html>