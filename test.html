<!DOCTYPE html>
<html>
	<title>Live View</title>
	<head>
		<script type="text/javascript" src="autobahn.js"></script>
		<script type="text/javascript" src="jquery.min.js"></script>
		<script>
			window.wssession = null;
			$(document).ready(function() {
				var wsUrl = "ws://localhost:9001";
				if (window.location.origin !== "file:///") {
					wsUrl = "ws://sugar.appendixg.com:9001";
				}
				ab.connect(wsUrl, function(session) {
					window.wssession = session;
					$("#output p").html("We have connected to websockets!");
					window.wssession.subscribe('feed', topicActivity);

				}, function(code, reason,detail) {
					console.log("WS connection attempt failed");
					console.log(reason);
					$("#output p").html("We have not connected to websockets!");
				}, {
					'maxRetries': 60,
					'retryDelay': 2000
				});
			});

			function topicActivity(topic, event) {
				event = JSON.parse(event);
				console.log(event);
				if (event.hasOwnProperty("username")) {
					$("#output p").html(event['username'] + ' said "' + event['message'] + '" at ' + event['created_date']);
					$("#output a").attr('href', 'http://twitter.com/' + event['username'] + '/status/' + event['twitter_id']);
				}
			}
		</script>
	</head>
	<body>
		<div id="output">
			<p></p>
			<a href="" target="_blank">Linky</a>
		</div>
	</body>
</html>